<script>
  const TZ = "America/Bogota";
  const limitSelect = document.getElementById("limit");
  const realBtn = document.getElementById("realtime");
  const histBtn = document.getElementById("history");
  const urlBase = "https://hermes-client.vercel.app/api/sensor/data/77c7cd49-b79f-4b62-90c2-9a3c2c2d6b94";
  let timer = null;

  const ctx = document.getElementById("chart").getContext("2d");

  let gradient;
  function makeGradient() {
    const { width, height } = ctx.canvas;
    gradient = ctx.createLinearGradient(0, 0, 0, height);
    gradient.addColorStop(0, "rgba(79,195,247,0.4)");
    gradient.addColorStop(1, "rgba(79,195,247,0)");
  }
  makeGradient();
  window.addEventListener("resize", makeGradient);

  const chart = new Chart(ctx, {
    type: "line",
    data: {
      datasets: [{
        label: "Valor del sensor",
        data: [],
        borderColor: "#4fc3f7",
        backgroundColor: () => gradient,
        fill: true,
        borderWidth: 2.8,
        tension: 0.35,
        pointRadius: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      parsing: false,
      scales: {
        x: {
          type: "time",
          adapters: { date: { zone: TZ } },
          time: { tooltipFormat: "HH:mm:ss", displayFormats: { minute: "HH:mm", hour: "HH:mm" } },
          title: { display: true, text: "Hora" },
          grid: { color: "rgba(255,255,255,0.1)" },
          ticks: { color: "#ccc" }
        },
        y: {
          beginAtZero: true,
          title: { display: true, text: "Valor" },
          grid: { color: "rgba(255,255,255,0.1)" },
          ticks: { color: "#ddd" }
        }
      },
      plugins: { legend: { display: false } }
    }
  });

  async function fetchData() {
    try {
      const limit = limitSelect.value.split(" ")[0];
      const res = await fetch(`${urlBase}?limit=${limit}`);
      const json = await res.json();

      console.log("üîπ Respuesta cruda:", json);

      // Validar estructura de datos
      if (!json || !json.data || !Array.isArray(json.data)) {
        console.warn("‚ö†Ô∏è Estructura inesperada, no hay datos v√°lidos.");
        return;
      }

      const pts = json.data
        .map(d => {
          const y = Number(d.value);
          const x = new Date(d.createdAt);
          if (!isNaN(y) && x) return { x, y };
          return null;
        })
        .filter(Boolean)
        .sort((a, b) => a.x - b.x);

      console.log("üìä Puntos procesados:", pts);

      chart.data.datasets[0].data = pts;
      chart.update("none");

      if (pts.length === 0) {
        console.warn("‚ö†Ô∏è No se encontraron puntos v√°lidos para graficar.");
      }
    } catch (err) {
      console.error("‚ùå Error al obtener o procesar datos:", err);
    }
  }

  function startRealtime() {
    clearInterval(timer);
    realBtn.style.background = "#2196f3";
    histBtn.style.background = "#333";
    fetchData();
    timer = setInterval(fetchData, 5000);
  }

  function stopRealtime() {
    clearInterval(timer);
    histBtn.style.background = "#2196f3";
    realBtn.style.background = "#333";
    fetchData();
  }

  realBtn.onclick = startRealtime;
  histBtn.onclick = stopRealtime;

  startRealtime();
</script>
